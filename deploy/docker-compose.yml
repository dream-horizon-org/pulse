services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: pulse-mysql
    ports:
      - "3307:3306"  # Using 3307 on host to avoid conflicts
    environment:
      - MYSQL_ROOT_PASSWORD=pulse_root_password
      - MYSQL_DATABASE=pulse_db
      - MYSQL_USER=pulse_user
      - MYSQL_PASSWORD=pulse_password
    volumes:
      - mysql-data:/var/lib/mysql
      - ./db/mysql-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - pulse-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-ppulse_root_password"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ClickHouse Database (OTEL data only - traces, logs, metrics)
  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    container_name: pulse-clickhouse
    ports:
      - "8123:8123"  # HTTP interface
      - "9000:9000"  # Native client
    environment:
      - CLICKHOUSE_DB=otel
      - CLICKHOUSE_USER=pulse_user
      - CLICKHOUSE_PASSWORD=pulse_password
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - ../backend/ingestion/clickhouse-otel-schema.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - pulse-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ClickHouse Table Initializer (runs once to ensure tables exist)
  clickhouse-init:
    image: clickhouse/clickhouse-server:24.8
    container_name: pulse-clickhouse-init
    command: /bin/bash /scripts/init-clickhouse.sh
    volumes:
      - ./scripts/init-clickhouse.sh:/scripts/init-clickhouse.sh:ro
      - ../backend/ingestion/clickhouse-otel-schema.sql:/init/clickhouse-otel-schema.sql:ro
    networks:
      - pulse-network
    depends_on:
      clickhouse:
        condition: service_healthy
    restart: "no"  # Only run once

  kafka:
    image: apache/kafka:latest
    container_name: kafka
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,EXTERNAL://localhost:9094
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
    ports:
      - "9094:9094"
    networks:
      - pulse-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092 > /dev/null 2>&1",
        ]
      interval: 10s
      timeout: 10s
      retries: 5

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "8081:8080"  # host:container (access UI at http://localhost:8081)
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      KAFKA_CLUSTERS_0_READONLY: "false"
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - pulse-network
    restart: unless-stopped

    # OpenTelemetry Collector (Data Ingestion Pipeline)

  otel-collector-1:
    image: otel/opentelemetry-collector-contrib:0.137.0
    container_name: pulse-otel-collector-1
    command: ["--config=/etc/otel-collector-1.yaml"]
    volumes:
      - ../backend/ingestion/otel-collector-1.yaml:/etc/otel-collector-1.yaml:ro
    networks:
      - pulse-network
    depends_on:
      kafka:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/otelcol-contrib", "validate", "--config=/etc/otel-collector-1.yaml"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    ports:
      - "4317:4317"   # OTLP gRPC receiver
      - "4318:4318"   # OTLP HTTP receiver
      - "8888:8888"   # Prometheus metrics (collector internal)
      - "13133:13133" # Health check

  otel-collector-2:
    image: otel/opentelemetry-collector-contrib:0.137.0
    container_name: pulse-otel-collector-2
    command: [ "--config=/etc/otel-collector-2.yaml" ]
    volumes:
      - ../backend/ingestion/otel-collector-2.yaml:/etc/otel-collector-2.yaml:ro
    environment:
      - CLICKHOUSE_ENDPOINT=tcp://clickhouse:9000
      - CLICKHOUSE_DATABASE=${OTEL_CLICKHOUSE_DATABASE:-otel}
      - CLICKHOUSE_USER=${OTEL_CLICKHOUSE_USER:-pulse_user}
      - CLICKHOUSE_PASSWORD=${OTEL_CLICKHOUSE_PASSWORD:-pulse_password}
    networks:
      - pulse-network
    depends_on:
      clickhouse:
        condition: service_healthy
      kafka:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "/otelcol-contrib", "validate", "--config=/etc/otel-collector-2.yaml" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    # Optional: expose health/metrics on different host ports than collector-1
    ports:
      - "8889:8888"    # internal metrics on 8888 -> host 8889
      - "13134:13133"  # internal health_check -> host 13134

  # Pulse UI Service (React Frontend)
  pulse-ui:
    build:
      context: ../pulse-ui
      dockerfile: Dockerfile
      args:
        REACT_APP_GOOGLE_CLIENT_ID: ${REACT_APP_GOOGLE_CLIENT_ID}
        REACT_APP_PULSE_SERVER_URL: ${REACT_APP_PULSE_SERVER_URL}
        REACT_APP_GOOGLE_OAUTH_ENABLED: ${GOOGLE_OAUTH_ENABLED:-false}
    container_name: pulse-ui
    ports:
      - "3000:80"
    environment:
      - NODE_ENV=production
    networks:
      - pulse-network
    depends_on:
      pulse-server:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/healthcheck.txt"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Pulse Server Service (Java/Vert.x Backend)
  pulse-server:
    build:
      context: ../backend/server
      dockerfile: Dockerfile
    container_name: pulse-server
    ports:
      - "8080:8080"
    environment:
      # MySQL Database Configuration
      - MYSQL_WRITER_HOST=mysql
      - MYSQL_READER_HOST=mysql
      - MYSQL_DATABASE=pulse_db
      - MYSQL_USER=pulse_user
      - MYSQL_PASSWORD=pulse_password
      - MYSQL_WRITER_MAX_POOL_SIZE=10
      - MYSQL_READER_MAX_POOL_SIZE=10

      # Application Configuration
      - CONFIG_SERVICE_APPLICATION_CRONMANAGERBASEURL=${CONFIG_SERVICE_APPLICATION_CRONMANAGERBASEURL}
      - CONFIG_SERVICE_APPLICATION_SERVICEURL=${CONFIG_SERVICE_APPLICATION_SERVICEURL}
      - CONFIG_SERVICE_APPLICATION_GOOGLEOAUTHCLIENTID=${CONFIG_SERVICE_APPLICATION_GOOGLEOAUTHCLIENTID}
      - CONFIG_SERVICE_APPLICATION_GOOGLEOAUTHENABLED=${GOOGLE_OAUTH_ENABLED:-false}
      - CONFIG_SERVICE_APPLICATION_JWTSECRET=${CONFIG_SERVICE_APPLICATION_JWTSECRET:-dev-secret-key-at-least-32-characters-long-for-local-testing-only}

      # ClickHouse Database Configuration
      - CLICKHOUSE_R2DBC_URL=r2dbc:clickhouse:http://clickhouse:8123/otel
      - CLICKHOUSE_USERNAME=pulse_user
      - CLICKHOUSE_PASSWORD=pulse_password
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=8123
    networks:
      - pulse-network
    depends_on:
      mysql:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    volumes:
      # Mount config files if needed for runtime configuration
      - ../backend/server/src/main/resources/config:/app/config:ro

networks:
  pulse-network:
    driver: bridge

volumes:
  mysql-data:
    driver: local
  clickhouse-data:
    driver: local

