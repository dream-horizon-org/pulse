services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: pulse-mysql
    ports:
      - "3307:3306"  # Using 3307 on host to avoid conflicts
    environment:
      - MYSQL_ROOT_PASSWORD=pulse_root_password
      - MYSQL_DATABASE=pulse_db
      - MYSQL_USER=pulse_user
      - MYSQL_PASSWORD=pulse_password
    volumes:
      - mysql-data:/var/lib/mysql
      - ./db/mysql-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - pulse-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-ppulse_root_password" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ClickHouse Database (OTEL data only - traces, logs, metrics)
  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    container_name: pulse-clickhouse
    ports:
      - "8123:8123"  # HTTP interface
      - "9000:9000"  # Native client
    environment:
      - CLICKHOUSE_DB=otel
      - CLICKHOUSE_USER=pulse_user
      - CLICKHOUSE_PASSWORD=pulse_password
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - ../backend/ingestion/clickhouse-otel-schema.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - pulse-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "clickhouse-client", "--query", "SELECT 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ClickHouse Table Initializer (runs once to ensure tables exist)
  clickhouse-init:
    image: clickhouse/clickhouse-server:24.8
    container_name: pulse-clickhouse-init
    command: /bin/bash /scripts/init-clickhouse.sh
    volumes:
      - ./scripts/init-clickhouse.sh:/scripts/init-clickhouse.sh:ro
      - ../backend/ingestion/clickhouse-otel-schema.sql:/init/clickhouse-otel-schema.sql:ro
    networks:
      - pulse-network
    depends_on:
      clickhouse:
        condition: service_healthy
    restart: "no"  # Only run once

  # OpenTelemetry Collector (Data Ingestion Pipeline)
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.137.0
    container_name: pulse-otel-collector
    command: [ "--config=/etc/otel-collector.yaml" ]
    volumes:
      - ../backend/ingestion/otel-collector.yaml:/etc/otel-collector.yaml:ro
    ports:
      - "4317:4317"   # OTLP gRPC receiver
      - "4318:4318"   # OTLP HTTP receiver
      - "8888:8888"   # Prometheus metrics (collector internal)
      - "13133:13133" # Health check
    environment:
      - CLICKHOUSE_ENDPOINT=tcp://clickhouse:9000
      - CLICKHOUSE_DATABASE=${OTEL_CLICKHOUSE_DATABASE:-otel}
      - CLICKHOUSE_USER=${OTEL_CLICKHOUSE_USER:-pulse_user}
      - CLICKHOUSE_PASSWORD=${OTEL_CLICKHOUSE_PASSWORD:-pulse_password}
    networks:
      - pulse-network
    depends_on:
      clickhouse:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "/otelcol-contrib", "validate", "--config=/etc/otel-collector.yaml" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Pulse UI Service (React Frontend)
  pulse-ui:
    build:
      context: ../pulse-ui
      dockerfile: Dockerfile
      args:
        REACT_APP_GOOGLE_CLIENT_ID: ${REACT_APP_GOOGLE_CLIENT_ID}
        REACT_APP_PULSE_SERVER_URL: ${REACT_APP_PULSE_SERVER_URL}
        REACT_APP_GOOGLE_OAUTH_ENABLED: ${GOOGLE_OAUTH_ENABLED:-false}
    container_name: pulse-ui
    ports:
      - "3000:80"
    environment:
      - NODE_ENV=production
    networks:
      - pulse-network
    depends_on:
      pulse-server:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/healthcheck.txt" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Pulse Server Service (Java/Vert.x Backend)
  pulse-server:
    build:
      context: ../backend/server
      dockerfile: Dockerfile
    container_name: pulse-server
    ports:
      - "8080:8080"
    environment:
      # MySQL Database Configuration
      - MYSQL_WRITER_HOST=mysql
      - MYSQL_READER_HOST=mysql
      - MYSQL_DATABASE=pulse_db
      - MYSQL_USER=pulse_user
      - MYSQL_PASSWORD=pulse_password
      - MYSQL_WRITER_MAX_POOL_SIZE=10
      - MYSQL_READER_MAX_POOL_SIZE=10

      # Application Configuration
      - CONFIG_SERVICE_APPLICATION_CRONMANAGERBASEURL=${CONFIG_SERVICE_APPLICATION_CRONMANAGERBASEURL:-http://pulse-alerts-cron:4000/cron}
      - CONFIG_SERVICE_APPLICATION_SERVICEURL=${CONFIG_SERVICE_APPLICATION_SERVICEURL:-http://pulse-server:8080}
      - CONFIG_SERVICE_APPLICATION_GOOGLEOAUTHCLIENTID=${CONFIG_SERVICE_APPLICATION_GOOGLEOAUTHCLIENTID}
      - CONFIG_SERVICE_APPLICATION_GOOGLEOAUTHENABLED=${GOOGLE_OAUTH_ENABLED:-false}
      - CONFIG_SERVICE_APPLICATION_JWTSECRET=${CONFIG_SERVICE_APPLICATION_JWTSECRET:-dev-secret-key-at-least-32-characters-long-for-local-testing-only}
      - CONFIG_SERVICE_APPLICATION_WEBHOOKURL=${CONFIG_SERVICE_APPLICATION_WEBHOOKURL}

      # ClickHouse Database Configuration
      - CLICKHOUSE_R2DBC_URL=r2dbc:clickhouse:http://clickhouse:8123/otel
      - CLICKHOUSE_USERNAME=pulse_user
      - CLICKHOUSE_PASSWORD=pulse_password
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=8123
    networks:
      - pulse-network
    depends_on:
      mysql:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/healthcheck" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    volumes:
      # Mount config files if needed for runtime configuration
      - ../backend/server/src/main/resources/config:/app/config:ro

  # Pulse Alerts Cron Service (Java/Vert.x Cron Manager)
  pulse-alerts-cron:
    build:
      context: ../backend/pulse-alerts-cron
      dockerfile: Dockerfile
    container_name: pulse-alerts-cron
    ports:
      - "4000:4000"
    environment:
      # MySQL Database Configuration
      - MYSQL_WRITER_HOST=mysql
      - MYSQL_READER_HOST=mysql
      - MYSQL_DATABASE=pulse_db
      - MYSQL_USER=pulse_user
      - MYSQL_PASSWORD=pulse_password

      # Application Configuration
      - CONFIG_SERVICE_APPLICATION_PULSESERVERURL=${CONFIG_SERVICE_APPLICATION_PULSESERVERURL:-http://pulse-server:8080}
      - CONFIG_SERVICE_APPLICATION_WEBHOOKURL=${CONFIG_SERVICE_APPLICATION_WEBHOOKURL}
    networks:
      - pulse-network
    depends_on:
      mysql:
        condition: service_healthy
      pulse-server:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:4000/healthcheck" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    volumes:
      # Mount config files if needed for runtime configuration
      - ../backend/pulse-alerts-cron/src/main/resources/config:/app/config:ro

networks:
  pulse-network:
    driver: bridge

volumes:
  mysql-data:
    driver: local
  clickhouse-data:
    driver: local

