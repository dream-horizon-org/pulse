name: Publish Android SDK to Maven Central

on:
  workflow_dispatch:
    inputs:
      final:
        description: 'Is this a final release? (true for releases, false for snapshots)'
        required: true
        type: choice
        options:
          - 'true'
          - 'false'
        default: 'true'

permissions:
  contents: read

jobs:
  publish:
    name: "Publish Android SDK to Maven Central"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

      - name: Set up JDK
        uses: actions/setup-java@99b8673ff64fbfb0a82b12e8a2c1c2b8b0c3b3e3  # v4.2.1
        with:
          distribution: temurin
          java-version: 17

      - name: Configure Gradle
        uses: gradle/gradle-build-action@29c0906b64b8fc82467890bfb7a0a7ef34bda89e  # v3.1.0

      - name: Publish to Maven Central
        working-directory: pulse-android-otel
        env:
          SONATYPE_USER: ${{ secrets.SONATYPE_USER }}
          SONATYPE_KEY: ${{ secrets.SONATYPE_KEY }}
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSWORD: ${{ secrets.GPG_PASSWORD }}
          CI: true
        run: |
          if [ "${{ inputs.final }}" == "true" ]; then
            ./gradlew publishToSonatype closeAndReleaseSonatypeStagingRepository -Pfinal=true --no-build-cache --no-configuration-cache --no-parallel
          else
            ./gradlew publishToSonatype --no-build-cache --no-configuration-cache --no-parallel
          fi

      - name: Publish Summary
        if: success()
        working-directory: pulse-android-otel
        run: |
          VERSION=$(grep "^version=" gradle.properties | cut -d'=' -f2)
          echo "## âœ… Published Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** ${{ inputs.final == 'true' && 'Release' || 'SNAPSHOT' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.final }}" == "true" ]; then
            echo "Artifact will be available at Maven Central in ~2 hours:" >> $GITHUB_STEP_SUMMARY
            echo "- \`org.dreamhorizon:pulse-android-sdk:$VERSION\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "SNAPSHOT artifact is available at:" >> $GITHUB_STEP_SUMMARY
            echo "- \`org.dreamhorizon:pulse-android-sdk:$VERSION-SNAPSHOT\`" >> $GITHUB_STEP_SUMMARY
            echo "- Repository: https://s01.oss.sonatype.org/content/repositories/snapshots/" >> $GITHUB_STEP_SUMMARY
          fi

