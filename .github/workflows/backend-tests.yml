name: Backend Tests

on:
  push:
    branches:
      - main
      - release/*
    paths:
      - 'backend/server/**'
      - '.github/workflows/backend-tests.yml'
  pull_request:
    paths:
      - 'backend/server/**'
      - '.github/workflows/backend-tests.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test:
    name: Run Backend Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write
    defaults:
      run:
        working-directory: ./backend/server

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00  # v4.7.1
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Cache Maven packages
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684  # v4.2.3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('backend/server/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Run tests with coverage
        run: mvn clean verify

      - name: Publish test report
        if: always()
        uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5  # v1.9.1
        with:
          name: Backend Test Results
          path: backend/server/target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: true

      - name: Install defusedxml for coverage script
        run: |
          python -m pip install --upgrade pip
          pip install defusedxml

      - name: Overall coverage (JaCoCo XML)
        if: success()
        working-directory: backend/server
        run: |
          python3 $GITHUB_WORKSPACE/.github/scripts/check_backend_coverage_overall.py \
            --report target/site/jacoco/jacoco.xml \
            --min-line 35
      - name: Changed files coverage (full metrics)
        if: success()
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          BASE_SHA: ${{ github.event.pull_request.base.sha || github.event.before }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha || github.sha }}
          PUSH_BEFORE: ${{ github.event.before }}
          PUSH_SHA: ${{ github.sha }}
        working-directory: backend/server
        run: |
          set -euo pipefail
          if [ "${EVENT_NAME}" = "pull_request" ] || [ "${EVENT_NAME}" = "pull_request_target" ]; then
            compare_range="${BASE_SHA}...${HEAD_SHA}"
          else
            compare_range="${PUSH_BEFORE}..${PUSH_SHA}"
          fi

          tmp_changed="$RUNNER_TEMP/changed_java.txt"
          git fetch --no-tags --depth=100 origin ${BASE_SHA} ${HEAD_SHA} ${PUSH_BEFORE} ${PUSH_SHA} || true
          git diff --name-only --diff-filter=ACMR ${compare_range} \
            | grep -E '^backend/server/src/main/java/.*\.java$' > "$tmp_changed" || true

          echo "Changed files:" >&2; cat "$tmp_changed" >&2 || true

          python3 $GITHUB_WORKSPACE/.github/scripts/check_backend_coverage_changed.py \
            --report target/site/jacoco/jacoco.xml \
            --changed-files "$tmp_changed" \
            --src-root backend/server/src/main/java \
            --min-line 80 \
            --min-branch 0 \
            --min-instruction 0 \
            --min-method 0 \
            --min-class 0
            # add --fail-if-no-changed if you want the job to fail when no data is found

      - name: Checkstyle summary
        if: always()
        run: |
          if [ -f target/checkstyle/checkstyle-report.xml ]; then
            violations=$(grep -c '<error' target/checkstyle/checkstyle-report.xml || echo "0")
            echo "### ðŸŽ¨ Checkstyle Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "$violations" -eq "0" ]; then
              echo "âœ… No Checkstyle violations found!" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Found $violations Checkstyle violations" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ“„ Download the full report from the workflow artifacts." >> $GITHUB_STEP_SUMMARY
            fi
          fi
  required-status-check:
    permissions:
      contents: read
    needs:
      - test
    runs-on: ubuntu-latest
    if: always()
    steps:
      - if: needs.test.result != 'success'
        run: exit 1
