name: Backend Tests

on:
  push:
    branches:
      - main
      - release/*
    paths:
      - 'backend/server/**'
      - '.github/workflows/backend-tests.yml'
  pull_request:
    paths:
      - 'backend/server/**'
      - '.github/workflows/backend-tests.yml'
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  test:
    name: Run Backend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend/server

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('backend/server/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Run tests with coverage
        run: mvn clean verify

      - name: Publish test report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Backend Test Results
          path: backend/server/target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: true

      - name: Code coverage summary
        if: success()
        run: |
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          import os
          import sys

          try:
              tree = ET.parse('target/site/jacoco/jacoco.xml')
              root = tree.getroot()

              counter = root.find("./counter[@type='LINE']")

              if counter is not None:
                  missed = int(counter.get('missed', 0))
                  covered = int(counter.get('covered', 0))
                  total = missed + covered

                  if total > 0:
                      percentage = (covered / total) * 100

                      with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
                          f.write('### ðŸ“Š Code Coverage Report\\n\\n')
                          f.write('#### Overall Coverage\\n')
                          f.write(f'**Coverage:** {percentage:.2f}%\\n')
                          f.write(f'- Lines Covered: {covered}\\n')
                          f.write(f'- Lines Missed: {missed}\\n')
                          f.write(f'- Total Lines: {total}\\n\\n')

                          if percentage < 35:
                              f.write(f'âŒ **Build Failed: Overall coverage ({percentage:.2f}%) is below minimum threshold of 35%**\\n\\n')
                              sys.exit(1)
                          else:
                              f.write('âœ… Coverage meets minimum threshold of 35%\\n\\n')
                  else:
                      with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
                          f.write('### ðŸ“Š Code Coverage Report\\n\\n')
                          f.write('âš ï¸ No coverage data available\\n\\n')
              else:
                  with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
                      f.write('### ðŸ“Š Code Coverage Report\\n\\n')
                      f.write('âš ï¸ LINE counter not found in report\\n\\n')
          except Exception as e:
              with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
                  f.write('### ðŸ“Š Code Coverage Report\\n\\n')
                  f.write(f'âš ï¸ Unable to parse coverage data: {str(e)}\\n\\n')
          EOF

      - name: Changed files coverage
        if: success()
        shell: bash
        env:
          EVENT_NAME: ${{ github.event_name }}
          BASE_SHA: ${{ github.event.pull_request.base.sha || github.event.before }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha || github.sha }}
          PUSH_BEFORE: ${{ github.event.before }}
          PUSH_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail

          echo "#### Changed Files Coverage" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "Event: $EVENT_NAME" >&2
          echo "BASE_SHA: ${BASE_SHA:-<nil>}" >&2
          echo "HEAD_SHA: ${HEAD_SHA:-<nil>}" >&2
          echo "PUSH_BEFORE: ${PUSH_BEFORE:-<nil>}" >&2
          echo "PUSH_SHA: ${PUSH_SHA:-<nil>}" >&2

          # Ensure the SHAs exist locally
          git fetch --no-tags --depth=100 origin "${BASE_SHA}" "${HEAD_SHA}" || true

          # Build compare range
          if [ "${EVENT_NAME}" = "pull_request" ] || [ "${EVENT_NAME}" = "pull_request_target" ]; then
            compare_range="${BASE_SHA}...${HEAD_SHA}"
            echo "Comparing (PR): ${compare_range}" >&2
          else
            git fetch --no-tags --depth=100 origin "${PUSH_BEFORE}" "${PUSH_SHA}" || true
            compare_range="${PUSH_BEFORE}..${PUSH_SHA}"
            echo "Comparing (push): ${compare_range}" >&2
          fi

          # Detect changed Java files under backend path
          changed_files=$(git diff --name-only --diff-filter=ACMR ${compare_range} 2>&1 \
            | tee /dev/stderr \
            | grep -E '^backend/server/src/main/java/.*\.java$' || true)

          echo "DEBUG: Changed files detected:" >&2
          echo "${changed_files}" >&2

          if [ -z "${changed_files}" ]; then
            echo "â„¹ï¸ No Java files changed under backend/server/src/main/java" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          file_count=$(echo "${changed_files}" | wc -l | awk '{print $1}')
          echo "**Files Analyzed:** ${file_count} Java file(s)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ ! -f target/site/jacoco/jacoco.xml ]; then
            echo "âš ï¸ Coverage report not found at target/site/jacoco/jacoco.xml" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          total_covered=0
          total_missed=0

          while IFS= read -r file; do
            # Relative path within src/main/java
            rel_path=$(echo "$file" | sed 's|^backend/server/src/main/java/||')
            pkg_dir=$(dirname "$rel_path")
            src_file=$(basename "$rel_path")
            class_slash=$(echo "$rel_path" | sed 's|\.java$||')   # in/horizonos/.../ErrorGroupingService

            # ---- Pass 1: exact package + sourcefilename ----
            read -r pkg_missed pkg_covered <<< "$(awk -v p=\"$pkg_dir\" -v s=\"$src_file\" '
              BEGIN { inpkg=0; inclass=0; missed=0; covered=0; }
              /<package / { inpkg=0; if ($0 ~ "name=\"" p "\"") inpkg=1 }
              inpkg && /<class / && $0 ~ "sourcefilename=\"" s "\"" { inclass=1; next }
              inpkg && inclass && /<counter / && /type=\"LINE\"/ {
                if (match($0, /missed=\"([0-9]+)\"/, m)) missed += m[1]
                if (match($0, /covered=\"([0-9]+)\"/, c)) covered += c[1]
                inclass=0
              }
              inpkg && /<\/package>/ { inpkg=0 }
              END { printf "%d %d\n", missed, covered }
            ' target/site/jacoco/jacoco.xml)"

            # ---- Pass 2: fallback by fully-qualified class name anywhere ----
            if { [ -z "${pkg_missed:-}" ] || [ -z "${pkg_covered:-}" ]; } || { [ "$pkg_missed" -eq 0 ] && [ "$pkg_covered" -eq 0 ]; }; then
              read -r pkg_missed pkg_covered <<< "$(awk -v c=\"$class_slash\" '
                BEGIN { inclass=0; missed=0; covered=0; }
                /<class / && $0 ~ "name=\"" c "\"" { inclass=1; next }
                inclass && /<counter / && /type=\"LINE\"/ {
                  if (match($0, /missed=\"([0-9]+)\"/, m)) missed += m[1]
                  if (match($0, /covered=\"([0-9]+)\"/, c)) covered += c[1]
                  inclass=0
                }
                END { printf "%d %d\n", missed, covered }
              ' target/site/jacoco/jacoco.xml)"
            fi

            # ---- Pass 3: fallback by sourcefilename anywhere ----
            if { [ -z "${pkg_missed:-}" ] || [ -z "${pkg_covered:-}" ]; } || { [ "$pkg_missed" -eq 0 ] && [ "$pkg_covered" -eq 0 ]; }; then
              read -r pkg_missed pkg_covered <<< "$(awk -v s=\"$src_file\" '
                BEGIN { inclass=0; missed=0; covered=0; }
                /<class / && $0 ~ "sourcefilename=\"" s "\"" { inclass=1; next }
                inclass && /<counter / && /type=\"LINE\"/ {
                  if (match($0, /missed=\"([0-9]+)\"/, m)) missed += m[1]
                  if (match($0, /covered=\"([0-9]+)\"/, c)) covered += c[1]
                  inclass=0
                }
                END { printf "%d %d\n", missed, covered }
              ' target/site/jacoco/jacoco.xml)"
            fi

            # Aggregate (or log if we still found nothing)
            if [ -n "${pkg_missed:-}" ] && [ -n "${pkg_covered:-}" ]; then
              echo "COVERAGE for ${rel_path}  ->  missed=${pkg_missed} covered=${pkg_covered}" >&2
              total_missed=$((total_missed + pkg_missed))
              total_covered=$((total_covered + pkg_covered))
            else
              echo "NOTE: Class not found in jacoco.xml (package/class/filename probes failed) -> ${class_slash}.java" >&2
            fi
          done <<< "${changed_files}"

          changed_total=$((total_covered + total_missed))
          if [ "${changed_total}" -eq 0 ]; then
            echo "â„¹ï¸ No coverage data available for changed files" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          changed_percentage=$(awk "BEGIN {printf \"%.2f\", (${total_covered} / ${changed_total}) * 100}")

          echo "**Coverage:** ${changed_percentage}%" >> "$GITHUB_STEP_SUMMARY"
          echo "- Lines Covered: ${total_covered}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Lines Missed: ${total_missed}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Total Lines: ${changed_total}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          threshold_check=$(awk "BEGIN {print (${changed_percentage} < 80) ? 1 : 0}")
          if [ "${threshold_check}" = "1" ]; then
            echo "âŒ **Build Failed: Changed files coverage (${changed_percentage}%) is below minimum threshold of 80%**" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          else
            echo "âœ… Changed files coverage meets the 80% requirement" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"

      #      - name: Upload Checkstyle report
#        if: always()
#        uses: actions/upload-artifact@v4
#        with:
#          name: checkstyle-report
#          path: backend/server/target/checkstyle/checkstyle-report.xml
#          retention-days: 30

      - name: Checkstyle summary
        if: success()
        run: |
          echo "### ðŸŽ¨ Checkstyle Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ ! -f target/checkstyle/checkstyle-report.xml ]; then
            echo "âš ï¸ Checkstyle report not found" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          violations=$(grep -c '<error' target/checkstyle/checkstyle-report.xml 2>/dev/null || echo "0")
          
          if [ "$violations" -eq "0" ]; then
            echo "âœ… No Checkstyle violations found!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Found $violations Checkstyle violations" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“„ Download the full report from the workflow artifacts." >> $GITHUB_STEP_SUMMARY
          fi

  required-status-check:
    permissions:
      contents: read
    needs:
      - test
    runs-on: ubuntu-latest
    if: always()
    steps:
      - if: needs.test.result != 'success'
        run: exit 1
